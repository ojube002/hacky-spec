using System.Collections;
using System;
using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.UI;
using Hacky.rest.models;

namespace Hacky.rest.services {

    interface IJsonSerializable
    {
        string ToJson();
    }


{{#operations}}
    public sealed class {{classname}} : MonoBehaviour
    {
        private {{classname}}() {}  
        private static readonly Lazy<{{classname}}> lazy = new Lazy<{{classname}}>(() => new {{classname}}());  
        public static {{classname}} Instance  
        {  
            get  
            {  
                return lazy.Value;  
            }  
        }  

        {{#operation}}
        /**
        * {{&notes}}
        {{#summary}}
        * @summary {{&summary}}
        {{/summary}}
        {{#allParams}}   
        * @param {{paramName}} {{description}}
        {{/allParams}}
        */
        public void {{nickname}}({{#allParams}} {{dataType}} {{paramName}}  {{#if @last}}, Action<{{dataType}}> onSuccess, Action<string> onError, string token, string json = null {{/if}} {{/allParams}}) {
           
           StartCoroutine(Request("{{httpMethod}}", $"https://bittineuvos.com/api{{path}}",onSuccess, onError, token, json));
        
        }

        {{/operation}}

        private IEnumerator Request<TModel,TError>(string reqmethod, string url, Action<TModel> onSuccess, Action<TError> onError, string token, string json = null)
        {

            
            using (UnityWebRequest www = CreateRequest(reqmethod,url,json))
            {
                www.SetRequestHeader("Authorization",$"Bearer {token}");
                yield return www.SendWebRequest();

                if (www.isNetworkError || www.isHttpError)
                {
                    Debug.Log($"{www.responseCode} : {www.downloadHandler.text}");
                    var error = (TError)Activator.CreateInstance(typeof(TError), www.downloadHandler.text);
                    onError(error);
                }
                else
                {
                    Debug.Log(www.downloadHandler.text);
                    var model = (TModel)Activator.CreateInstance(typeof(TModel), www.downloadHandler.text);
                    onSuccess(model);

                }
                 
            }
        }
        private UnityWebRequest CreateRequest(string reqmethod, string url, string data = null)
        {
            if(reqmethod == "POST") return UnityWebRequest.Post(url,data);
            else if(reqmethod == "GET") return UnityWebRequest.Get(url);
            else if(reqmethod == "PUT") return UnityWebRequest.Put(url,data);
            else if(reqmethod == "DELETE") return UnityWebRequest.Delete(url);
            return null;
        }
       
    }
{{/operations}}

} 